# social_web_api_server
高負荷に耐えられるソシャゲサーバー構築

##　概要
* phalcon3フレームワークを採用。
* php拡張にてzephirで高速化。
* コモンDBに極力負荷をかけない設計。
* KVSがクラッシュしても最小範囲の障害で済むように。
* O/Rマッパーは個人的には使いたくないが一応使えるようにする。 → 今後の課題：現状はコモンDBに向いているのでシャーディングに対応予定。
* MySQLからの結果が全て文字列になるので必要に応じて数値型に高速変換。

## 環境
* CentOS6.9
* MySQL5.7
* Redis
* memcached
* PHP7
* PHP-FPM
* nginx

## phalcon3フレームワーク
* 自由なのでオレオレフレームワークになりがちだが、それを望む。

## php拡張にてzephir
* PHP5より7はかなり速くなったが、やはりPHPは遅い。
* 冗長な処理だとC言語に変換できるzephirはPHP野郎には優しい。

## コモンDBにアクセスを極力しない方針。
* ログイン認証はRedisでキャッシュ化
* シャーディングバランスもコモンDBを見ずRedisのzRange()でバランシング。

## KVSがクラッシュ
* リビルドすることで解決できるように。

## O/Rマッパー
* こいつの良いとこ取りができれば。。。
* マスターなんかは結構いける。
* mst_chara.sql でDBに定義。
* MstChara.php　を定義。
* $data = MstChara::findFirst($id); なお手軽感。
* とりあえず、マスターデータをmemcachedにキャッシュした。

## MySQLからの結果が全て文字列
* ほぼそのままで実害ないですが、前はレンダリングに渡すときに json_encode( $responce , JSON_NUMERIC_CHECK ); で勝手に数値にしてたが、
* MsgPack経由でのシリアライズを電文を採用したので、型が文字列だと受け取るクライアントの取り回しがわるい。
* ちまちま型をみて変換すると変換しないマスター取得の７倍近いコストがかかるので馬鹿にならない。
* zephirで変換すると実用レベルの速さにはなったので使いたいときに使おう。
